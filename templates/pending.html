<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾…æ”¶è´§ - æç®€è®°è´¦æœ¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        info: '#06b6d4',
                        light: '#f9fafb',
                        dark: '#1e293b',
                        'primary-light': '#dbeafe',
                        'secondary-light': '#f1f5f9',
                        'border-color': '#e2e8f0'
                    },
                    fontFamily: {
                        sans: ['Inter', 'Microsoft YaHei', 'sans-serif']
                    },
                    boxShadow: {
                        'card': '0 2px 8px 0 rgba(0, 0, 0, 0.08)',
                        'card-hover': '0 4px 16px 0 rgba(0, 0, 0, 0.12)',
                        'modal': '0 8px 32px 0 rgba(0, 0, 0, 0.16)'
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card {
                @apply bg-white rounded-xl shadow-card transition-all duration-300;
            }
            .card:hover {
                @apply shadow-card-hover transform -translate-y-1;
            }
            .btn {
                @apply px-4 py-2 rounded-lg font-medium transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2;
            }
            .btn-primary {
                @apply bg-primary text-white hover:bg-primary/90 focus:ring-primary;
            }
            .btn-secondary {
                @apply bg-secondary text-white hover:bg-secondary/90 focus:ring-secondary;
            }
            .btn-success {
                @apply bg-success text-white hover:bg-success/90 focus:ring-success;
            }
            .btn-danger {
                @apply bg-danger text-white hover:bg-danger/90 focus:ring-danger;
            }
            .btn-outline {
                @apply border border-border-color text-secondary hover:bg-secondary-light focus:ring-primary;
            }
            .input {
                @apply w-full px-4 py-2 border border-border-color rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent;
            }
            .select {
                @apply w-full px-4 py-2 border border-border-color rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent;
            }
            .nav-item {
                @apply flex flex-col items-center justify-center gap-1 px-4 py-3 transition-all duration-200 relative;
            }
            .nav-item.active {
                @apply text-primary;
            }
            .nav-item.active::after {
                @apply content-[''] absolute bottom-0 left-1/2 transform -translate-x-1/2 w-1/2 h-0.5 bg-primary rounded-full;
            }
            .nav-item:hover {
                @apply text-primary;
            }
            .nav-icon {
                @apply text-xl;
            }
            .nav-label {
                @apply text-xs font-medium;
            }
            .table-hover {
                @apply hover:bg-gray-50 transition-colors;
            }
            .btn-sm {
                @apply px-3 py-1 text-sm;
            }
            /* ç¡®ä¿è¡¨æ ¼å•å…ƒæ ¼å†…å®¹æ°´å¹³æ’åˆ— */
            #pendingTable td {
                white-space: nowrap;
                vertical-align: middle;
            }
            /* ç¡®ä¿æ“ä½œæŒ‰é’®æ°´å¹³æ’åˆ— */
            #pendingTable td .btn {
                display: inline-block;
                margin-right: 8px;
            }
            #pendingTable td .btn:last-child {
                margin-right: 0;
            }
        }
    </style>
    <style>
        /* å…¨å±€æ ·å¼ */
        body {
            font-family: 'Inter', 'Microsoft YaHei', sans-serif;
        }
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-light font-sans">
    <!-- ä¸»å†…å®¹åŒº -->
    <main class="flex-grow container mx-auto px-4 py-6 pb-20">
        <div class="space-y-6">
            <div class="flex justify-between items-center">
                <h1 class="text-xl sm:text-2xl font-bold text-secondary">å¾…æ”¶è´§</h1>
            </div>

        <!-- å¾…æ”¶è´§åˆ—è¡¨è¡¨æ ¼ - æ¡Œé¢ç«¯ -->
        <div class="card overflow-x-auto hidden md:block">
            <table class="w-full border-collapse" id="pendingTable">
                <thead>
                    <tr class="bg-secondary-light">
                        <th class="px-4 py-3 text-left text-sm font-medium text-secondary border-b border-border-color whitespace-nowrap">æ¶ˆè´¹å†…å®¹</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-secondary border-b border-border-color whitespace-nowrap">æ€»ä»·</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-secondary border-b border-border-color whitespace-nowrap">è´­ä¹°æ¸ é“</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-secondary border-b border-border-color whitespace-nowrap">è´­ä¹°æ—¥æœŸ</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-secondary border-b border-border-color whitespace-nowrap">å–ä»¶ç </th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-secondary border-b border-border-color whitespace-nowrap">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% if pending_list %}
                        {% for item in pending_list %}
                        <tr data-id="{{ item.id }}" class="table-hover">
                            <td class="px-4 py-3 text-sm border-b whitespace-nowrap">{{ item.content }}</td>
                            <td class="px-4 py-3 text-sm font-medium text-secondary border-b whitespace-nowrap">Â¥{{ item.total_price }}</td>
                            <td class="px-4 py-3 text-sm border-b whitespace-nowrap">{{ item.channel }}</td>
                            <td class="px-4 py-3 text-sm border-b whitespace-nowrap create-time">{{ item.create_time }}</td>
                            <td class="px-4 py-3 text-sm border-b whitespace-nowrap">{{ item.pickup_code or '-' }}</td>
                            <td class="px-4 py-3 text-sm border-b whitespace-nowrap">
                                <div class="flex items-center gap-2">
                                    <button class="btn btn-primary btn-sm" onclick="addPickupCode({{ item.id }})">æ·»åŠ å–ä»¶ç </button>
                                    <button class="btn btn-success btn-sm" onclick="confirmReceive({{ item.id }})">ç¡®è®¤æ”¶è´§</button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="6" class="py-16 text-center text-gray-500 text-lg">
                                æš‚æ— å¾…æ”¶è´§æ¶ˆè´¹é¡¹ ğŸ‰
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        
        <!-- å¾…æ”¶è´§åˆ—è¡¨å¡ç‰‡ - ç§»åŠ¨ç«¯ -->
        <div class="space-y-4 md:hidden">
            {% if pending_list %}
                {% for item in pending_list %}
                <div class="card p-4" data-id="{{ item.id }}">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-medium text-secondary mb-1">{{ item.content }}</h3>
                            <p class="text-sm text-gray-500">ID: {{ item.id }}</p>
                        </div>
                        <span class="px-2 py-1 text-xs rounded bg-warning/10 text-warning">
                            å¾…æ”¶è´§
                        </span>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <div class="text-sm">
                            <span class="text-gray-500">æ€»ä»·:</span> <span class="font-medium text-secondary">Â¥{{ item.total_price }}</span>
                        </div>
                        <div class="text-sm">
                            <span class="text-gray-500">è´­ä¹°æ¸ é“:</span> {{ item.channel }}
                        </div>
                        <div class="text-sm">
                            <span class="text-gray-500">è´­ä¹°æ—¥æœŸ:</span> {{ item.create_time }}
                        </div>
                        <div class="text-sm">
                            <span class="text-gray-500">å–ä»¶ç :</span> {{ item.pickup_code or '-' }}
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button class="flex-1 py-2 text-sm btn btn-primary" onclick="addPickupCode({{ item.id }})">æ·»åŠ å–ä»¶ç </button>
                        <button class="flex-1 py-2 text-sm btn btn-success" onclick="confirmReceive({{ item.id }})">ç¡®è®¤æ”¶è´§</button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="card p-10 text-center text-gray-500">
                    <i class="fa fa-box text-3xl mb-3"></i>
                    <p>æš‚æ— å¾…æ”¶è´§æ¶ˆè´¹é¡¹ ğŸ‰</p>
                </div>
            {% endif %}
        </div>
        </div>
    </main>

    <!-- å–ä»¶ç è¾“å…¥å¼¹çª— -->
    <div id="pickupCodeModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">æ·»åŠ å–ä»¶ç </h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">å–ä»¶ç </label>
                <input type="text" id="pickupCodeInput" class="input" placeholder="è¯·è¾“å…¥å–ä»¶ç " maxlength="50">
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="cancelPickupCode" class="btn btn-secondary" onclick="closePickupCodeModal()">å–æ¶ˆ</button>
                <button id="submitPickupCode" class="btn btn-primary" onclick="submitPickupCode()">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <footer class="fixed bottom-0 left-0 right-0 bg-white shadow-md z-40">
        <div class="flex justify-around items-center h-16">
            <a href="/" class="nav-item">
                <i class="fa fa-home nav-icon"></i>
                <span class="nav-label">é¦–é¡µ</span>
            </a>
            <a href="/list" class="nav-item">
                <i class="fa fa-plus-circle nav-icon"></i>
                <span class="nav-label">è®°è´¦</span>
            </a>
            <a href="/pending" class="nav-item active">
                <i class="fa fa-truck nav-icon"></i>
                <span class="nav-label">å¾…æ”¶è´§</span>
                {% if pending_count > 0 %}
                <span class="absolute -top-1 -right-1 bg-danger text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">
                    {{ pending_count }}
                </span>
                {% endif %}
            </a>
            <a href="/price" class="nav-item">
                <i class="fa fa-bar-chart nav-icon"></i>
                <span class="nav-label">ç»Ÿè®¡</span>
            </a>
            <a href="/manage" class="nav-item">
                <i class="fa fa-cog nav-icon"></i>
                <span class="nav-label">è®¾ç½®</span>
            </a>
        </div>
    </footer>

    <!-- è„šæœ¬ï¼šç¡®è®¤æ”¶è´§é€»è¾‘ -->
    <script>
        // å…¨å±€å˜é‡å­˜å‚¨å½“å‰æ“ä½œçš„ID
        let currentPickupCodeId = null;

        // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
        function formatDateDisplay(dateStr) {
            if (!dateStr) return '';
            try {
                // å°è¯•è§£æå¸¦æ—¶é—´çš„æ ¼å¼
                const dt = new Date(dateStr);
                const year = dt.getFullYear();
                const month = String(dt.getMonth() + 1).padStart(2, '0');
                const day = String(dt.getDate()).padStart(2, '0');
                const hours = String(dt.getHours()).padStart(2, '0');
                const minutes = String(dt.getMinutes()).padStart(2, '0');
                const seconds = String(dt.getSeconds()).padStart(2, '0');
                return `${year}å¹´${month}æœˆ${day}æ—¥ ${hours}:${minutes}:${seconds}`;
            } catch (error) {
                return dateStr;
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ ¼å¼åŒ–æ—¥æœŸ
        document.addEventListener('DOMContentLoaded', function() {
            const dateElements = document.querySelectorAll('.create-time');
            dateElements.forEach(element => {
                const originalDate = element.textContent;
                element.textContent = formatDateDisplay(originalDate);
            });
        });

        // æ‰“å¼€å–ä»¶ç è¾“å…¥å¼¹çª—
        function addPickupCode(id) {
            currentPickupCodeId = id;
            document.getElementById('pickupCodeInput').value = '';
            document.getElementById('pickupCodeModal').classList.remove('hidden');
        }

        // å…³é—­å–ä»¶ç è¾“å…¥å¼¹çª—
        function closePickupCodeModal() {
            currentPickupCodeId = null;
            document.getElementById('pickupCodeModal').classList.add('hidden');
        }

        // æäº¤å–ä»¶ç 
        function submitPickupCode() {
            if (!currentPickupCodeId) {
                closePickupCodeModal();
                return;
            }

            const pickupCode = document.getElementById('pickupCodeInput').value.trim();
            if (!pickupCode) {
                alert('è¯·è¾“å…¥å–ä»¶ç ');
                return;
            }

            // è°ƒç”¨æ›´æ–°æ¥å£
            fetch(`/api/consumption/${currentPickupCodeId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ pickupCode: pickupCode })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('å–ä»¶ç æ·»åŠ æˆåŠŸï¼');
                    // åˆ·æ–°é¡µé¢
                    window.location.reload();
                } else {
                    alert('æ›´æ–°å¤±è´¥ï¼š' + data.message);
                }
            })
            .catch(error => {
                console.error('æ·»åŠ å–ä»¶ç å¤±è´¥ï¼š', error);
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•ï¼');
            })
            .finally(() => {
                closePickupCodeModal();
            });
        }

        // ç¡®è®¤æ”¶è´§
        function confirmReceive(id) {
            if (!confirm('ç¡®å®šè¦æ ‡è®°ä¸ºã€Œå·²æ”¶è´§ã€å—ï¼Ÿ')) {
                return;
            }

            // è°ƒç”¨æ›´æ–°æ¥å£
            fetch(`/api/consumption/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ receiveStatus: 'å·²æ”¶è´§' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('æ”¶è´§çŠ¶æ€æ›´æ–°æˆåŠŸï¼');
                    // åˆ·æ–°é¡µé¢
                    window.location.reload();
                } else {
                    alert('æ›´æ–°å¤±è´¥ï¼š' + data.message);
                }
            })
            .catch(error => {
                console.error('ç¡®è®¤æ”¶è´§å¤±è´¥ï¼š', error);
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•ï¼');
            });
        }
    </script>
</body>
</html>