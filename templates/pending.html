<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾…æ”¶è´§ - æç®€è®°è´¦æœ¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        info: '#06b6d4',
                        light: '#f9fafb',
                        dark: '#1e293b',
                        'primary-light': '#dbeafe',
                        'secondary-light': '#f1f5f9',
                        'border-color': '#e2e8f0'
                    },
                    fontFamily: {
                        sans: ['Inter', 'Microsoft YaHei', 'sans-serif']
                    },
                    fontSize: {
                        'xs': ['0.75rem', { lineHeight: '1rem' }],
                        'sm': ['0.875rem', { lineHeight: '1.25rem' }],
                        'base': ['1rem', { lineHeight: '1.5rem' }],
                        'lg': ['1.125rem', { lineHeight: '1.75rem' }],
                        'xl': ['1.25rem', { lineHeight: '1.75rem' }],
                        '2xl': ['1.5rem', { lineHeight: '2rem' }]
                    },
                    boxShadow: {
                        'card': '0 2px 8px 0 rgba(0, 0, 0, 0.08)',
                        'card-hover': '0 4px 16px 0 rgba(0, 0, 0, 0.12)',
                        'modal': '0 8px 32px 0 rgba(0, 0, 0, 0.16)'
                    }
                }
            }
        }
    </script>
    <!-- å¼•å…¥å…¬å…±æ ·å¼ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* å…¨å±€æ ·å¼ */
        body {
            font-family: 'Inter', 'Microsoft YaHei', sans-serif;
        }
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* ç§»åŠ¨ç«¯å¼¹çª—åŠ¨ç”» */
        .modal-backdrop {
            transition: opacity 0.3s ease;
        }
        .modal-backdrop.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .modal-backdrop:not(.hidden) {
            opacity: 1;
        }
        .modal-backdrop:not(.hidden) .modal-content {
            transform: translateY(0);
        }
        @media (min-width: 768px) {
            .modal-backdrop.hidden .modal-content {
                transform: scale(0.95);
            }
            .modal-backdrop:not(.hidden) .modal-content {
                transform: scale(1);
            }
        }
    </style>
</head>
<body class="bg-light font-sans">
    <!-- ä¸»å†…å®¹åŒº -->
    <main class="flex-grow container mx-auto px-4 py-6 pb-20">
        <div class="space-y-6">
            <div class="flex justify-between items-center">
                <h1 class="text-xl font-bold text-secondary">å¾…æ”¶è´§</h1>
            </div>

        <!-- å¾…æ”¶è´§åˆ—è¡¨è¡¨æ ¼ - æ¡Œé¢ç«¯ -->
        <div class="card overflow-x-auto hidden md:block">
            <table class="w-full border-collapse" id="pendingTable">
                <thead>
                    <tr class="bg-secondary-light">
                        <th class="px-3 py-2 text-left text-sm font-medium text-secondary border-b border-border-color whitespace-nowrap">æ¶ˆè´¹å†…å®¹</th>
                        <th class="px-3 py-2 text-left text-sm font-medium text-secondary border-b border-border-color whitespace-nowrap">æ€»ä»·</th>
                        <th class="px-3 py-2 text-left text-sm font-medium text-secondary border-b border-border-color whitespace-nowrap">è´­ä¹°æ¸ é“</th>
                        <th class="px-3 py-2 text-left text-sm font-medium text-secondary border-b border-border-color whitespace-nowrap">è´­ä¹°æ—¥æœŸ</th>
                        <th class="px-3 py-2 text-left text-sm font-medium text-secondary border-b border-border-color whitespace-nowrap">å–ä»¶ç </th>
                        <th class="px-3 py-2 text-left text-sm font-medium text-secondary border-b border-border-color whitespace-nowrap">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% if pending_list %}
                        {% for item in pending_list %}
                        <tr data-id="{{ item.id }}" class="table-hover">
                            <td class="px-3 py-2 text-sm border-b whitespace-nowrap">{{ item.content }}</td>
                            <td class="px-3 py-2 text-sm font-medium text-secondary border-b whitespace-nowrap">Â¥{{ item.total_price }}</td>
                            <td class="px-3 py-2 text-sm border-b whitespace-nowrap">{{ item.channel }}</td>
                            <td class="px-3 py-2 text-sm border-b whitespace-nowrap create-time">{{ item.create_time }}</td>
                            <td class="px-3 py-2 text-sm border-b whitespace-nowrap">{{ item.pickup_code or '-' }}</td>
                            <td class="px-3 py-2 text-sm border-b whitespace-nowrap">
                                <div class="flex items-center gap-1">
                                    <button class="btn-action" onclick="addPickupCode({{ item.id }})"><i class="fa fa-qrcode"></i>æ·»åŠ å–ä»¶ç </button>
                                    <button class="btn-use" onclick="confirmReceive({{ item.id }})"><i class="fa fa-check"></i>ç¡®è®¤æ”¶è´§</button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="6" class="py-12 text-center text-gray-500 text-base">
                                æš‚æ— å¾…æ”¶è´§æ¶ˆè´¹é¡¹ ğŸ‰
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        
        <!-- å¾…æ”¶è´§åˆ—è¡¨å¡ç‰‡ - ç§»åŠ¨ç«¯ -->
        <div class="space-y-4 md:hidden">
            {% if pending_list %}
                {% for item in pending_list %}
                <div class="card p-4" data-id="{{ item.id }}">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-medium text-secondary mb-1">{{ item.content }}</h3>
                        </div>
                        <span class="px-2 py-1 text-xs rounded bg-warning/10 text-warning">
                            å¾…æ”¶è´§
                        </span>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <div class="text-sm">
                            <span class="text-gray-500">æ€»ä»·:</span> <span class="font-medium text-secondary">Â¥{{ item.total_price }}</span>
                        </div>
                        <div class="text-sm">
                            <span class="text-gray-500">è´­ä¹°æ¸ é“:</span> {{ item.channel }}
                        </div>
                        <div class="text-sm">
                            <span class="text-gray-500">è´­ä¹°æ—¥æœŸ:</span> {{ item.create_time }}
                        </div>
                        <div class="text-sm">
                            <span class="text-gray-500">å–ä»¶ç :</span> {{ item.pickup_code or '-' }}
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn-action flex-1" onclick="addPickupCode({{ item.id }})"><i class="fa fa-qrcode"></i>æ·»åŠ å–ä»¶ç </button>
                        <button class="btn-use flex-1" onclick="confirmReceive({{ item.id }})"><i class="fa fa-check"></i>ç¡®è®¤æ”¶è´§</button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="card p-10 text-center text-gray-500">
                    <i class="fa fa-box text-3xl mb-3"></i>
                    <p>æš‚æ— å¾…æ”¶è´§æ¶ˆè´¹é¡¹ ğŸ‰</p>
                </div>
            {% endif %}
        </div>
        </div>
    </main>

    <!-- å–ä»¶ç è¾“å…¥å¼¹çª— - ç§»åŠ¨ç«¯é£æ ¼ -->
    <div id="pickupCodeModal" class="fixed inset-0 bg-black/60 z-50 hidden modal-backdrop">
        <div class="absolute inset-x-0 bottom-0 md:inset-0 md:flex md:items-center md:justify-center md:p-4">
            <div class="bg-white w-full md:w-full md:max-w-sm md:rounded-2xl rounded-t-2xl shadow-2xl modal-content transform transition-transform duration-300 translate-y-full md:translate-y-0">
                <!-- å¤´éƒ¨ -->
                <div class="p-4 border-b flex justify-between items-center bg-gray-50 relative">
                    <div class="md:hidden w-12 h-1 bg-gray-300 rounded-full mx-auto absolute top-2 left-1/2 -translate-x-1/2"></div>
                    <h3 class="text-base font-semibold text-gray-800 mt-2 md:mt-0">æ·»åŠ å–ä»¶ç </h3>
                    <button onclick="closePickupCodeModal()" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-600 hover:bg-gray-300 transition-colors">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <!-- å†…å®¹åŒºåŸŸ -->
                <div class="p-3 md:p-4">
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">å–ä»¶ç </label>
                        <input type="text" id="pickupCodeInput" class="input w-full text-sm py-2" placeholder="è¯·è¾“å…¥å–ä»¶ç " maxlength="50">
                    </div>
                </div>
                <!-- åº•éƒ¨æŒ‰é’® -->
                <div class="p-3 border-t bg-gray-50 flex gap-2">
                    <button id="cancelPickupCode" class="btn-neutral flex-1 py-2" onclick="closePickupCodeModal()"><i class="fa fa-times"></i>å–æ¶ˆ</button>
                    <button id="submitPickupCode" class="btn-action flex-1 py-2" onclick="submitPickupCode()"><i class="fa fa-check"></i>ç¡®è®¤</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç§»åŠ¨ç«¯é£æ ¼ç¡®è®¤å¼¹çª— -->
    <div id="mobileConfirmModal" class="fixed inset-0 bg-black/60 z-50 hidden modal-backdrop">
        <div class="absolute inset-x-0 bottom-0 md:inset-0 md:flex md:items-center md:justify-center md:p-4">
            <div class="bg-white w-full md:w-full md:max-w-sm md:rounded-2xl rounded-t-2xl shadow-2xl modal-content transform transition-transform duration-300 translate-y-full md:translate-y-0">
                <div class="p-4 text-center">
                    <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-orange-100 flex items-center justify-center">
                        <i class="fa fa-question text-xl text-orange-500"></i>
                    </div>
                    <h3 class="text-base font-semibold text-gray-800 mb-2" id="confirmTitle">ç¡®è®¤æ“ä½œ</h3>
                    <p class="text-gray-600 text-sm" id="confirmMessage">ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
                </div>
                <div class="p-3 border-t bg-gray-50 flex gap-2">
                    <button onclick="closeMobileConfirm()" class="btn-neutral flex-1 py-2">å–æ¶ˆ</button>
                    <button onclick="executeMobileConfirm()" class="btn-action flex-1 py-2">ç¡®è®¤</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast è½»æç¤º -->
    <div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 z-50 hidden">
        <div class="bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3 min-w-[200px] max-w-[80vw]">
            <i class="fas fa-info-circle" id="toastIcon"></i>
            <span id="toastMessage" class="text-sm">æç¤ºä¿¡æ¯</span>
        </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <footer class="fixed bottom-0 left-0 right-0 bg-white shadow-md z-40">
        <div class="flex justify-around items-center h-16">
            <a href="/" class="nav-item">
                <i class="fa fa-home nav-icon"></i>
                <span class="nav-label">é¦–é¡µ</span>
            </a>
            <a href="/list" class="nav-item">
                <i class="fa fa-plus-circle nav-icon"></i>
                <span class="nav-label">è®°è´¦</span>
            </a>
            <a href="/pending" class="nav-item active">
                <i class="fa fa-truck nav-icon"></i>
                <span class="nav-label">å¾…æ”¶è´§</span>
                {% if pending_count > 0 %}
                <span class="absolute -top-1 -right-1 bg-danger text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">
                    {{ pending_count }}
                </span>
                {% endif %}
            </a>
            <a href="/price" class="nav-item">
                <i class="fa fa-bar-chart nav-icon"></i>
                <span class="nav-label">ç»Ÿè®¡</span>
            </a>
            <a href="/manage" class="nav-item">
                <i class="fa fa-cog nav-icon"></i>
                <span class="nav-label">è®¾ç½®</span>
            </a>
        </div>
    </footer>

    <!-- è„šæœ¬ï¼šç¡®è®¤æ”¶è´§é€»è¾‘ -->
    <script src="{{ url_for('static', filename='js/common.js') }}"></script>
    <script>
        // å…¨å±€å˜é‡å­˜å‚¨å½“å‰æ“ä½œçš„ID
        let currentPickupCodeId = null;
        let currentReceiveId = null;

        // é¡µé¢åŠ è½½æ—¶æ ¼å¼åŒ–æ—¥æœŸ
        document.addEventListener('DOMContentLoaded', function() {
            const dateElements = document.querySelectorAll('.create-time');
            dateElements.forEach(element => {
                const originalDate = element.textContent;
                element.textContent = formatDateDisplay(originalDate);
            });
        });

        // æ‰“å¼€å–ä»¶ç è¾“å…¥å¼¹çª—
        function addPickupCode(id) {
            currentPickupCodeId = id;
            document.getElementById('pickupCodeInput').value = '';
            document.getElementById('pickupCodeModal').classList.remove('hidden');
        }

        // å…³é—­å–ä»¶ç è¾“å…¥å¼¹çª—
        function closePickupCodeModal() {
            currentPickupCodeId = null;
            document.getElementById('pickupCodeModal').classList.add('hidden');
        }

        // æäº¤å–ä»¶ç 
        function submitPickupCode() {
            if (!currentPickupCodeId) {
                closePickupCodeModal();
                return;
            }

            const pickupCode = document.getElementById('pickupCodeInput').value.trim();
            if (!pickupCode) {
                showToast('è¯·è¾“å…¥å–ä»¶ç ', 'info');
                return;
            }

            // è°ƒç”¨æ›´æ–°æ¥å£
            fetch(`/api/consumption/${currentPickupCodeId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ pickupCode: pickupCode })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('å–ä»¶ç æ·»åŠ æˆåŠŸï¼', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showToast('æ›´æ–°å¤±è´¥ï¼š' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('æ·»åŠ å–ä»¶ç å¤±è´¥ï¼š', error);
                showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•ï¼', 'error');
            })
            .finally(() => {
                closePickupCodeModal();
            });
        }

        // ç¡®è®¤æ”¶è´§
        function confirmReceive(id) {
            currentReceiveId = id;
            showMobileConfirm('ç¡®è®¤æ”¶è´§', 'ç¡®å®šè¦æ ‡è®°ä¸ºã€Œå·²æ”¶è´§ã€å—ï¼Ÿ', function() {
                executeReceive(currentReceiveId);
            }, 'warning');
        }

        // æ‰§è¡Œæ”¶è´§
        function executeReceive(id) {
            // è°ƒç”¨æ›´æ–°æ¥å£
            fetch(`/api/consumption/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ receiveStatus: 'å·²æ”¶è´§' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('æ”¶è´§çŠ¶æ€æ›´æ–°æˆåŠŸï¼', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showToast('æ›´æ–°å¤±è´¥ï¼š' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('ç¡®è®¤æ”¶è´§å¤±è´¥ï¼š', error);
                showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•ï¼', 'error');
            });
        }
    </script>
</body>
</html>