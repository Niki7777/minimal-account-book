<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>记账 - 极简记账本</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Flatpickr (现代化日期选择器) -->
    <link href="{{ url_for('static', filename='css/lib/flatpickr.min.css') }}" rel="stylesheet">
    <script src="{{ url_for('static', filename='js/flatpickr.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/flatpickr.zh.js') }}"></script>
    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        info: '#06b6d4',
                        light: '#f9fafb',
                        dark: '#1e293b',
                        'primary-light': '#dbeafe',
                        'secondary-light': '#f1f5f9',
                        'border-color': '#e2e8f0'
                    },
                    fontFamily: {
                        sans: ['Inter', 'Microsoft YaHei', 'sans-serif']
                    },
                    fontSize: {
                        'xs': ['0.75rem', { lineHeight: '1rem' }],
                        'sm': ['0.875rem', { lineHeight: '1.25rem' }],
                        'base': ['1rem', { lineHeight: '1.5rem' }],
                        'lg': ['1.125rem', { lineHeight: '1.75rem' }],
                        'xl': ['1.25rem', { lineHeight: '1.75rem' }],
                        '2xl': ['1.5rem', { lineHeight: '2rem' }]
                    },
                    boxShadow: {
                        'card': '0 2px 8px 0 rgba(0, 0, 0, 0.08)',
                        'card-hover': '0 4px 16px 0 rgba(0, 0, 0, 0.12)',
                        'modal': '0 8px 32px 0 rgba(0, 0, 0, 0.16)'
                    }
                }
            }
        }
    </script>
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card {
                @apply bg-white rounded-xl shadow-card transition-all duration-300;
            }
            .card:hover {
                @apply shadow-card-hover transform -translate-y-1;
            }
            .btn {
                @apply px-3 py-2 rounded-lg font-medium text-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2;
            }
            .btn-primary {
                @apply bg-primary text-white hover:bg-primary/90 focus:ring-primary;
            }
            .btn-secondary {
                @apply bg-secondary text-white hover:bg-secondary/90 focus:ring-secondary;
            }
            .btn-success {
                @apply bg-success text-white hover:bg-success/90 focus:ring-success;
            }
            .btn-danger {
                @apply bg-danger text-white hover:bg-danger/90 focus:ring-danger;
            }
            .btn-outline {
                @apply border border-border-color text-secondary hover:bg-secondary-light focus:ring-primary;
            }
            /* 移动端友好按钮样式 - 浅色背景配彩色文字 */
            .btn-edit {
                @apply px-3 py-2 rounded-lg font-medium text-sm transition-all duration-200 bg-amber-100 text-amber-600 hover:bg-amber-200 active:bg-amber-300 focus:outline-none focus:ring-2 focus:ring-amber-400 flex items-center justify-center gap-1;
            }
            .btn-use {
                @apply px-3 py-2 rounded-lg font-medium text-sm transition-all duration-200 bg-emerald-100 text-emerald-600 hover:bg-emerald-200 active:bg-emerald-300 focus:outline-none focus:ring-2 focus:ring-emerald-400 flex items-center justify-center gap-1;
            }
            .btn-delete {
                @apply px-3 py-2 rounded-lg font-medium text-sm transition-all duration-200 bg-rose-100 text-rose-600 hover:bg-rose-200 active:bg-rose-300 focus:outline-none focus:ring-2 focus:ring-rose-400 flex items-center justify-center gap-1;
            }
            .btn-action {
                @apply px-3 py-2 rounded-lg font-medium text-sm transition-all duration-200 bg-blue-100 text-blue-600 hover:bg-blue-200 active:bg-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-400 flex items-center justify-center gap-1;
            }
            .btn-neutral {
                @apply px-3 py-2 rounded-lg font-medium text-sm transition-all duration-200 bg-gray-100 text-gray-600 hover:bg-gray-200 active:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 flex items-center justify-center gap-1;
            }
            .input {
                @apply w-full px-4 py-2 border border-border-color rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent;
            }
            .select {
                @apply w-full px-4 py-2 border border-border-color rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent;
            }
            .nav-item {
                @apply flex flex-col items-center justify-center gap-1 px-4 py-3 transition-all duration-200 relative;
            }
            .nav-item.active {
                @apply text-primary;
            }
            .nav-item.active::after {
                @apply content-[''] absolute bottom-0 left-1/2 transform -translate-x-1/2 w-1/2 h-0.5 bg-primary rounded-full;
            }
            .nav-item:hover {
                @apply text-primary;
            }
            .nav-icon {
                @apply text-xl;
            }
            .nav-label {
                @apply text-xs font-medium;
            }
        }
    </style>
    <style>
        /* 全局样式 */
        body {
            font-family: 'Inter', 'Microsoft YaHei', sans-serif;
        }
        /* 自定义滚动条 */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        /* 日期选择器样式 */
        .flatpickr-day.selected {
            background-color: #3b82f6 !important;
            border-color: #3b82f6 !important;
        }
        .flatpickr-day:hover {
            background-color: #dbeafe !important;
        }
        
        /* 日期输入框样式 - 使用内联SVG背景图标 */
        .date-input-wrapper {
            position: relative;
            display: block;
        }
        .date-input-wrapper input {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' ry='2'%3E%3C/rect%3E%3Cline x1='16' y1='2' x2='16' y2='6'%3E%3C/line%3E%3Cline x1='8' y1='2' x2='8' y2='6'%3E%3C/line%3E%3Cline x1='3' y1='10' x2='21' y2='10'%3E%3C/line%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px 16px;
            padding-right: 40px;
            cursor: pointer;
            /* 隐藏浏览器默认日期图标 */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            pointer-events: auto !important;
        }
        /* 针对Webkit浏览器的日期输入框 */
        .date-input-wrapper input::-webkit-calendar-picker-indicator {
            opacity: 0;
            display: none;
            -webkit-appearance: none;
        }
        /* 针对IE/Edge */
        .date-input-wrapper input::-ms-clear,
        .date-input-wrapper input::-ms-reveal {
            display: none;
        }
        /* 确保日期输入框可点击 */
        .date-input-wrapper input[readonly] {
            pointer-events: auto !important;
            cursor: pointer;
        }
        
        /* 移动端日期选择器适配 */
        @media (max-width: 767px) {
            .flatpickr-calendar {
                width: 90vw !important;
                max-width: 320px !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                position: fixed !important;
                top: 50% !important;
                transform: translate(-50%, -50%) !important;
                z-index: 9999 !important;
            }
            .flatpickr-calendar.open {
                display: block !important;
            }
            .flatpickr-days {
                width: 100% !important;
            }
            .dayContainer {
                width: 100% !important;
                min-width: 100% !important;
                max-width: 100% !important;
            }
            .flatpickr-day {
                max-width: none !important;
                height: 40px !important;
                line-height: 40px !important;
            }
        }
        
        /* 表格样式 */
        #consumptionTableBody tr {
            height: 48px;
            white-space: nowrap;
        }
        
        #consumptionTableBody td {
            vertical-align: middle;
        }
        
        /* 确保操作按钮水平排列 */
        #consumptionTableBody td .flex {
            align-items: center;
        }
        
        /* 移动端弹窗动画 */
        .modal-backdrop {
            transition: opacity 0.3s ease;
        }
        .modal-backdrop.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .modal-backdrop:not(.hidden) {
            opacity: 1;
        }
        .modal-backdrop:not(.hidden) .modal-content {
            transform: translateY(0);
        }
        @media (min-width: 768px) {
            .modal-backdrop.hidden .modal-content {
                transform: scale(0.95);
            }
            .modal-backdrop:not(.hidden) .modal-content {
                transform: scale(1);
            }
        }
    </style>
</head>
<body class="bg-light font-sans">
    <!-- 主内容区 -->
    <main class="flex-grow container mx-auto px-4 py-6 pb-20">
        <div class="space-y-6">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-secondary">记账</h1>
                <div class="flex gap-3">
                    <button class="btn-action text-base" onclick="openAddModal()">
                        <i class="fa fa-plus"></i>记一笔
                    </button>
                    <button class="btn-neutral text-base" onclick="openBatchModal()">
                        <i class="fa fa-files-o"></i>批量
                    </button>
                </div>
            </div>

            <!-- 时间范围查询 -->
            <div class="card p-4">
                <div class="flex flex-wrap gap-4 items-center">
                    <div class="flex flex-col gap-1 flex-1 min-w-[200px]">
                        <label class="text-base font-medium text-secondary">开始日期</label>
                        <div class="relative date-input-wrapper">
                            <input
                                id="startDate"
                                type="text"
                                class="input w-full text-base"
                                placeholder="选择开始日期"
                            >
                        </div>
                    </div>
                    <div class="flex flex-col gap-1 flex-1 min-w-[200px]">
                        <label class="text-base font-medium text-secondary">结束日期</label>
                        <div class="relative date-input-wrapper">
                            <input
                                id="endDate"
                                type="text"
                                class="input w-full text-base"
                                placeholder="选择结束日期"
                            >
                        </div>
                    </div>
                    <div class="flex items-end gap-2">
                        <button onclick="loadConsumptionList()" class="btn-action text-base">
                            <i class="fa fa-search"></i>查询
                        </button>
                        <button onclick="resetDateRange()" class="btn-neutral">
                            <i class="fa fa-refresh"></i>重置
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 消费列表表格 - 桌面端 -->
            <div class="card overflow-hidden hidden md:block">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-secondary-light">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-medium text-secondary">消费内容</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-secondary">数量</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-secondary">总价</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-secondary">购买渠道</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-secondary">账单类型</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-secondary">统计类型</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-secondary">收货状态</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-secondary">购买时间</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-secondary">操作</th>
                            </tr>
                        </thead>
                        <tbody id="consumptionTableBody">
                            <!-- 动态加载数据 -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 消费列表卡片 - 移动端 -->
            <div class="space-y-4 md:hidden" id="mobileConsumptionList">
                <!-- 动态加载卡片数据 -->
            </div>
        </div>
    </main>

    <!-- Toast 轻提示 -->
    <div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 z-50 hidden">
        <div class="bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3 min-w-[200px] max-w-[80vw]">
            <i class="fas fa-info-circle" id="toastIcon"></i>
            <span id="toastMessage" class="text-sm">提示信息</span>
        </div>
    </div>

    <!-- 底部导航栏 -->
    <footer class="fixed bottom-0 left-0 right-0 bg-white shadow-md z-40">
        <div class="flex justify-around items-center h-16">
            <a href="/" class="nav-item">
                <i class="fa fa-home nav-icon"></i>
                <span class="nav-label">首页</span>
            </a>
            <a href="/list" class="nav-item active">
                <i class="fa fa-plus-circle nav-icon"></i>
                <span class="nav-label">记账</span>
            </a>
            <a href="/pending" class="nav-item">
                <i class="fa fa-truck nav-icon"></i>
                <span class="nav-label">待收货</span>
                <span v-if="{{ pending_count }} > 0" class="absolute -top-1 -right-1 bg-danger text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">
                    {{ pending_count }}
                </span>
            </a>
            <a href="/price" class="nav-item">
                <i class="fa fa-bar-chart nav-icon"></i>
                <span class="nav-label">统计</span>
            </a>
            <a href="/manage" class="nav-item">
                <i class="fa fa-cog nav-icon"></i>
                <span class="nav-label">设置</span>
            </a>
        </div>
    </footer>

    <!-- 单条新增弹窗 - 简洁实用设计 -->
    <div id="addModal" class="fixed inset-0 bg-black/60 z-50 hidden modal-backdrop">
        <div class="absolute inset-x-0 bottom-0 md:inset-0 md:flex md:items-center md:justify-center md:p-4">
            <div class="bg-white w-full md:w-full md:max-w-lg md:rounded-2xl rounded-t-3xl max-h-[90vh] md:max-h-[90vh] overflow-hidden flex flex-col shadow-2xl modal-content transform transition-transform duration-300 translate-y-full md:translate-y-0">
                <!-- 头部 -->
                <div class="px-4 pt-3 pb-3 border-b border-gray-100">
                    <div class="w-10 h-1 bg-gray-300 rounded-full mx-auto mb-3"></div>
                    <div class="flex items-center justify-between">
                        <button onclick="closeAddModal()" class="text-gray-500 px-2 py-1 text-base">取消</button>
                        <h3 class="text-lg font-semibold text-gray-800">记一笔</h3>
                        <button onclick="submitAdd()" class="text-primary font-semibold px-2 py-1 text-base">保存</button>
                    </div>
                </div>
                <!-- 内容区域 -->
                <div class="flex-1 overflow-y-auto p-4 space-y-4">
                    <!-- 消费内容 - 最常用，放最上面 -->
                    <div>
                        <label class="block text-sm text-gray-500 mb-2">消费内容 <span class="text-red-500">*</span></label>
                        <input type="text" id="content" placeholder="例如：午餐、打车、买书..." class="w-full text-lg bg-gray-50 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-primary/30">
                    </div>
                    
                    <!-- 金额和数量 - 并排 -->
                    <div class="flex gap-3">
                        <div class="flex-1">
                            <label class="block text-sm text-gray-500 mb-2">金额 <span class="text-red-500">*</span></label>
                            <div class="flex items-center bg-gray-50 rounded-xl px-4 py-3">
                                <span class="text-lg text-gray-400 mr-2">¥</span>
                                <input type="number" id="totalPrice" value="" step="0.01" class="flex-1 text-lg bg-transparent outline-none" placeholder="0.00">
                            </div>
                        </div>
                        <div class="w-24">
                            <label class="block text-sm text-gray-500 mb-2">数量</label>
                            <input type="number" id="quantity" value="1" step="0.1" class="w-full text-lg bg-gray-50 rounded-xl px-4 py-3 text-center outline-none focus:ring-2 focus:ring-primary/30">
                        </div>
                    </div>
                    
                    <!-- 分类选择 - 渠道和类型 -->
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm text-gray-500 mb-2">购买渠道 <span class="text-red-500">*</span></label>
                            <select id="channel" class="w-full text-base bg-gray-50 rounded-xl px-3 py-3 outline-none focus:ring-2 focus:ring-primary/30">
                                {% for ch in channels %}
                                <option value="{{ ch.name }}">{{ ch.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-500 mb-2">账单类型 <span class="text-red-500">*</span></label>
                            <select id="mainType" class="w-full text-base bg-gray-50 rounded-xl px-3 py-3 outline-none focus:ring-2 focus:ring-primary/30">
                                {% for mt in main_types %}
                                <option value="{{ mt.name }}">{{ mt.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- 统计相关 - 折叠或简化 -->
                    <div class="border-t border-gray-100 pt-4">
                        <div class="flex items-center gap-3 mb-3">
                            <input type="checkbox" id="enableStats" class="w-5 h-5 rounded border-gray-300 text-primary focus:ring-primary" onchange="toggleStats(this)">
                            <label for="enableStats" class="text-sm text-gray-600">计入统计（用于价格分析）</label>
                        </div>
                        <div id="statsSection" class="grid grid-cols-2 gap-3 opacity-50 pointer-events-none transition-opacity">
                            <div>
                                <label class="block text-sm text-gray-500 mb-2">统计类型</label>
                                <select id="subType" class="w-full text-base bg-gray-50 rounded-xl px-3 py-3 outline-none">
                                    {% for st in sub_types %}
                                    <option value="{{ st.name }}">{{ st.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-500 mb-2">换算系数</label>
                                <input type="number" id="unitCoefficient" value="1" step="0.1" class="w-full text-base bg-gray-50 rounded-xl px-3 py-3 outline-none">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 其他设置 -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="relative">
                            <label class="block text-sm text-gray-500 mb-2">收货状态</label>
                            <button type="button" id="receiveStatusBtn" onclick="showReceiveStatusActionSheet()" class="w-full text-base bg-gray-50 rounded-xl px-3 py-3 outline-none focus:ring-2 focus:ring-primary/30 text-left flex items-center justify-between">
                                <span id="receiveStatusText">已收货</span>
                                <i class="fa fa-chevron-right text-gray-400 text-sm"></i>
                            </button>
                            <input type="hidden" id="receiveStatus" value="已收货">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-500 mb-2">购买时间</label>
                            <div class="date-input-wrapper">
                                <input type="text" id="purchaseTime" class="w-full text-base bg-gray-50 rounded-xl px-3 py-3 outline-none" placeholder="选择时间">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 使用消费项弹窗 - 移动端风格 -->
    <div id="useModal" class="fixed inset-0 bg-black/60 z-50 hidden modal-backdrop">
        <div class="absolute inset-x-0 bottom-0 md:inset-0 md:flex md:items-center md:justify-center md:p-4">
            <div class="bg-white w-full md:w-full md:max-w-lg md:rounded-2xl rounded-t-2xl max-h-[90vh] md:max-h-[90vh] overflow-hidden flex flex-col shadow-2xl modal-content transform transition-transform duration-300 translate-y-full md:translate-y-0">
                <!-- 头部 -->
                <div class="p-4 border-b flex justify-between items-center bg-gray-50 relative">
                    <div class="md:hidden w-12 h-1 bg-gray-300 rounded-full mx-auto absolute top-2 left-1/2 -translate-x-1/2"></div>
                    <h3 class="text-lg font-semibold text-secondary mt-2 md:mt-0">使用消费项</h3>
                    <button onclick="closeUseModal()" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-600 hover:bg-gray-300 transition-colors">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <!-- 内容区域 -->
                <div class="p-4 md:p-6 overflow-y-auto flex-1 space-y-5" id="batchModalContent" ontouchmove="event.stopPropagation()">
                    <!-- 消费项信息卡片 -->
                    <div id="useItemInfo" class="bg-blue-50 p-4 rounded-xl border border-blue-100 text-base"></div>
                    
                    <!-- 时间选择 -->
                    <div id="useFormContainer" class="space-y-5">
                        <div class="date-input-wrapper">
                            <label class="block text-base font-medium text-secondary mb-2">使用开始时间</label>
                            <input type="text" class="use-start-time input w-full text-base py-3" placeholder="选择开始时间">
                        </div>
                        <div class="date-input-wrapper">
                            <label class="block text-base font-medium text-secondary mb-2">使用结束时间</label>
                            <input type="text" class="use-end-time input w-full text-base py-3" placeholder="选择结束时间">
                        </div>
                    </div>
                </div>
                <!-- 底部按钮 -->
                <div class="p-4 border-t bg-gray-50 flex gap-3">
                    <button onclick="addMoreUseItem()" class="btn-neutral flex-1 py-3">
                        <i class="fa fa-plus"></i>添加记录
                    </button>
                    <button onclick="submitUseItem()" class="btn-action flex-1 py-3">
                        <i class="fa fa-check"></i>提交
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 批量新增弹窗 - 简洁列表设计 -->
    <div id="batchModal" class="fixed inset-0 bg-black/60 z-50 hidden modal-backdrop">
        <div class="absolute inset-x-0 bottom-0 md:inset-0 md:flex md:items-center md:justify-center md:p-4">
            <div class="bg-white w-full md:w-full md:max-w-lg md:rounded-2xl rounded-t-3xl max-h-[90vh] md:max-h-[90vh] overflow-hidden flex flex-col shadow-2xl modal-content transform transition-transform duration-300 translate-y-full md:translate-y-0">
                <!-- 头部 -->
                <div class="px-4 pt-3 pb-3 border-b border-gray-100">
                    <div class="w-10 h-1 bg-gray-300 rounded-full mx-auto mb-3"></div>
                    <div class="flex items-center justify-between">
                        <button onclick="closeBatchModal()" class="text-gray-500 px-2 py-1 text-base">取消</button>
                        <h3 class="text-lg font-semibold text-gray-800">批量记账</h3>
                        <button onclick="submitBatch()" class="text-primary font-semibold px-2 py-1 text-base">保存</button>
                    </div>
                </div>
                <!-- 内容区域 -->
                <div class="flex-1 overflow-y-auto p-4" id="batchModalContent" ontouchmove="event.stopPropagation()">
                    <!-- 统一设置（可选） -->
                    <div class="bg-blue-50 rounded-xl p-3 mb-4">
                        <div class="text-sm text-blue-600 mb-2 font-medium">统一设置（可选）</div>
                        <div class="grid grid-cols-2 gap-2">
                            <select id="batchDefaultChannel" class="text-sm bg-white rounded-lg px-3 py-2 outline-none" onchange="applyBatchDefaults()">
                                <option value="">购买渠道</option>
                                {% for ch in channels %}
                                <option value="{{ ch.name }}">{{ ch.name }}</option>
                                {% endfor %}
                            </select>
                            <select id="batchDefaultType" class="text-sm bg-white rounded-lg px-3 py-2 outline-none" onchange="applyBatchDefaults()">
                                <option value="">账单类型</option>
                                {% for mt in main_types %}
                                <option value="{{ mt.name }}">{{ mt.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- 消费项列表 -->
                    <div id="batchFormContainer" class="space-y-3">
                        <!-- 初始一行 -->
                        <div class="batch-item bg-gray-50 rounded-xl p-3">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-gray-400 text-sm w-6">1</span>
                                <input type="text" class="batch-content flex-1 bg-white rounded-lg px-3 py-2 text-base outline-none" placeholder="消费内容">
                                <button onclick="removeBatchItem(this)" class="text-gray-300 hover:text-red-400 w-8">
                                    <i class="fa fa-times"></i>
                                </button>
                            </div>
                            <div class="flex gap-2 ml-6">
                                <div class="flex items-center bg-white rounded-lg px-2 py-2 flex-1">
                                    <span class="text-gray-400 text-sm mr-1">¥</span>
                                    <input type="number" class="batch-totalPrice w-full bg-transparent outline-none text-base" placeholder="金额" step="0.01">
                                </div>
                                <input type="number" class="batch-quantity w-16 bg-white rounded-lg px-2 py-2 text-center text-base outline-none" value="1" step="0.1" placeholder="数量">
                                <select class="batch-channel w-20 bg-white rounded-lg px-2 py-2 text-sm outline-none">
                                    {% for ch in channels %}
                                    <option value="{{ ch.name }}">{{ ch.name }}</option>
                                    {% endfor %}
                                </select>
                                <select class="batch-mainType w-20 bg-white rounded-lg px-2 py-2 text-sm outline-none">
                                    {% for mt in main_types %}
                                    <option value="{{ mt.name }}">{{ mt.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 添加按钮 -->
                    <button onclick="addMoreBatchItem()" class="w-full mt-3 py-3 bg-gray-100 rounded-xl text-gray-600 hover:bg-gray-200 transition-colors flex items-center justify-center gap-2">
                        <i class="fa fa-plus"></i>
                        <span>添加一项</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 显示 Toast 轻提示
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const msg = document.getElementById('toastMessage');
            const icon = document.getElementById('toastIcon');
            
            msg.textContent = message;
            
            // 设置图标和颜色
            if (type === 'error') {
                icon.className = 'fas fa-times-circle text-red-400';
            } else if (type === 'success') {
                icon.className = 'fas fa-check-circle text-green-400';
            } else {
                icon.className = 'fas fa-info-circle text-blue-400';
            }
            
            toast.classList.remove('hidden');
            
            // 3秒后自动隐藏
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // 初始化日期选择器
        document.addEventListener('DOMContentLoaded', function() {
            // 购买时间选择器
            if (typeof flatpickr !== 'undefined') {
                try {
                    flatpickr('#purchaseTime', {
                        locale: 'zh',
                        dateFormat: 'Y-m-d H:i',
                        enableTime: true,
                        disableMobile: true,
                        position: 'auto',
                        appendTo: document.body,
                        clickOpens: true,
                        allowInput: false
                    });
                    
                    // 时间范围查询选择器
                    flatpickr('#startDate', {
                        locale: 'zh',
                        dateFormat: 'Y-m-d',
                        maxDate: 'today',
                        disableMobile: true,
                        position: 'auto',
                        appendTo: document.body,
                        clickOpens: true,
                        allowInput: false
                    });
                    
                    flatpickr('#endDate', {
                        locale: 'zh',
                        dateFormat: 'Y-m-d',
                        maxDate: 'today',
                        disableMobile: true,
                        position: 'auto',
                        appendTo: document.body,
                        clickOpens: true,
                        allowInput: false
                    });
                } catch (error) {
                    console.error('初始化日期选择器失败:', error);
                }
            }
            
            // 设置默认时间范围为近一个月
            setDefaultDateRange();
            
            // 页面加载时加载消费列表
            loadConsumptionList();
        });
        
        // 设置默认时间范围为近一个月
        function setDefaultDateRange() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setMonth(startDate.getMonth() - 1);
            
            // 格式化日期为 YYYY-MM-DD
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            document.getElementById('startDate').value = formatDate(startDate);
            document.getElementById('endDate').value = formatDate(endDate);
        }
        
        // 重置日期范围
        function resetDateRange() {
            setDefaultDateRange();
            loadConsumptionList();
        }

        // 加载消费列表
        function loadConsumptionList() {
            console.log('开始加载消费列表...');
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            // 构建API请求URL
            let url = '/api/consumption';
            if (startDate && endDate) {
                url += `?startDate=${startDate}&endDate=${endDate}`;
            }
            
            fetch(url)
                .then(res => {
                    console.log('API响应状态:', res.status);
                    if (!res.ok) {
                        throw new Error('网络响应错误: ' + res.status);
                    }
                    return res.json().catch(jsonError => {
                        console.error('解析JSON失败:', jsonError);
                        throw new Error('服务器返回的数据格式错误');
                    });
                })
                .then(data => {
                    console.log('API响应数据:', data);
                    
                    // 检查数据格式
                    if (typeof data !== 'object' || data === null) {
                        throw new Error('服务器返回的数据格式错误');
                    }
                    
                    if (data.success) {
                        const tableBody = document.getElementById('consumptionTableBody');
                        const mobileList = document.getElementById('mobileConsumptionList');
                        
                        tableBody.innerHTML = '';
                        mobileList.innerHTML = '';
                        
                        if (Array.isArray(data.data) && data.data.length > 0) {
                            data.data.forEach(item => {
                                try {
                                    // 桌面端表格数据
                                    const tr = document.createElement('tr');
                                    tr.className = 'border-b hover:bg-secondary-light/50 transition-colors h-12';
                                    tr.innerHTML = `
                                        <td class="px-4 py-3 text-sm font-medium truncate">${item.content || '-'}</td>
                                        <td class="px-4 py-3 text-sm">${item.quantity || '-'}</td>
                                        <td class="px-4 py-3 text-sm font-medium text-secondary">¥${typeof item.total_price === 'number' ? item.total_price.toFixed(2) : (parseFloat(item.total_price) || 0).toFixed(2)}</td>
                                        <td class="px-4 py-3 text-sm">${item.channel || '-'}</td>
                                        <td class="px-4 py-3 text-sm">${item.main_type || '-'}</td>
                                        <td class="px-4 py-3 text-sm">${item.sub_type || '-'}</td>
                                        <td class="px-4 py-3 text-sm">
                                            <span class="${item.receive_status === '已收货' ? 'text-success' : 'text-warning'}">
                                                ${item.receive_status || '-'}
                                            </span>
                                        </td>
                                        <td class="px-4 py-3 text-sm">${formatDateDisplay(item.create_time)}</td>
                                        <td class="px-4 py-3 text-sm">
                                            <div class="flex gap-2">
                                                <button class="btn-edit" data-id="${item.id}" onclick="editItemById(${item.id})">
                                                    <i class="fa fa-pencil"></i>编辑
                                                </button>
                                                <button class="btn-use" data-id="${item.id}" onclick="useItemById(${item.id})">
                                                    <i class="fa fa-check"></i>使用
                                                </button>
                                                <button class="btn-delete" data-id="${item.id}" onclick="deleteItem(${item.id})">
                                                    <i class="fa fa-trash"></i>删除
                                                </button>
                                            </div>
                                        </td>
                                    `;
                                    tableBody.appendChild(tr);
                                    
                                    // 移动端卡片数据
                                    const card = document.createElement('div');
                                    card.className = 'card p-4';
                                    card.innerHTML = `
                                        <div class="flex justify-between items-start mb-3">
                                            <div>
                                                <h3 class="font-medium text-secondary mb-1">${item.content || '-'}</h3>
                                            </div>
                                            <span class="px-2 py-1 text-xs rounded ${item.receive_status === '已收货' ? 'bg-success/10 text-success' : 'bg-warning/10 text-warning'}">
                                                ${item.receive_status || '-'}
                                            </span>
                                        </div>
                                        <div class="grid grid-cols-2 gap-2 mb-3">
                                            <div class="text-sm">
                                                <span class="text-gray-500">数量:</span> ${item.quantity || '-'}
                                            </div>
                                            <div class="text-sm">
                                                <span class="text-gray-500">总价:</span> <span class="font-medium text-secondary">¥${typeof item.total_price === 'number' ? item.total_price.toFixed(2) : (parseFloat(item.total_price) || 0).toFixed(2)}</span>
                                            </div>
                                            <div class="text-sm">
                                                <span class="text-gray-500">购买渠道:</span> ${item.channel || '-'}
                                            </div>
                                            <div class="text-sm">
                                                <span class="text-gray-500">账单类型:</span> ${item.main_type || '-'}
                                            </div>
                                            <div class="text-sm">
                                                <span class="text-gray-500">统计类型:</span> ${item.sub_type || '-'}
                                            </div>
                                            <div class="text-sm">
                                                <span class="text-gray-500">购买时间:</span> ${formatDateDisplay(item.create_time).split(' ')[0]}
                                            </div>
                                        </div>
                                        <div class="flex gap-2">
                                            <button class="btn-edit flex-1" data-id="${item.id}" onclick="editItemById(${item.id})">
                                                <i class="fa fa-pencil"></i>编辑
                                            </button>
                                            <button class="btn-use flex-1" data-id="${item.id}" onclick="useItemById(${item.id})">
                                                <i class="fa fa-check"></i>使用
                                            </button>
                                            <button class="btn-delete flex-1" data-id="${item.id}" onclick="deleteItem(${item.id})">
                                                <i class="fa fa-trash"></i>删除
                                            </button>
                                        </div>
                                    `;
                                    mobileList.appendChild(card);
                                } catch (itemError) {
                                    console.error('渲染消费项失败:', itemError, item);
                                    // 跳过有问题的项，继续渲染其他项
                                }
                            });
                        } else {
                            console.log('没有消费数据');
                            // 清空表格
                            tableBody.innerHTML = '';
                            
                            // 在表格中显示空数据提示（桌面端）
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td colspan="9" class="px-4 py-10 text-center text-gray-500">
                                    <i class="fa fa-inbox text-3xl mb-3"></i>
                                    <p>暂无消费记录</p>
                                    <p class="text-sm text-gray-400 mt-1">点击"记一笔"开始添加消费记录</p>
                                </td>
                            `;
                            tableBody.appendChild(tr);
                            
                            // 在移动端显示空数据提示
                            mobileList.innerHTML = `
                                <div class="card p-10 text-center text-gray-500">
                                    <i class="fa fa-inbox text-3xl mb-3"></i>
                                    <p>暂无消费记录</p>
                                    <p class="text-sm text-gray-400 mt-1">点击"记一笔"开始添加消费记录</p>
                                </div>
                            `;
                        }
                    } else {
                        console.error('API请求失败:', data.message);
                        const errorMessage = data.message || '未知错误';
                        
                        // 清空表格
                        const tableBody = document.getElementById('consumptionTableBody');
                        tableBody.innerHTML = '';
                        const mobileList = document.getElementById('mobileConsumptionList');
                        mobileList.innerHTML = '';
                        
                        // 在表格中显示错误提示（桌面端）
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td colspan="9" class="px-4 py-10 text-center text-gray-500">
                                <i class="fa fa-exclamation-circle text-3xl mb-3"></i>
                                <p>加载失败</p>
                                <p class="text-sm text-gray-400 mt-1">${errorMessage}</p>
                                <button onclick="loadConsumptionList()" class="mt-3 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                                    重试
                                </button>
                            </td>
                        `;
                        tableBody.appendChild(tr);
                        
                        // 在移动端显示错误提示
                        mobileList.innerHTML = `
                            <div class="card p-10 text-center text-gray-500">
                                <i class="fa fa-exclamation-circle text-3xl mb-3"></i>
                                <p>加载失败</p>
                                <p class="text-sm text-gray-400 mt-1">${errorMessage}</p>
                                <button onclick="loadConsumptionList()" class="mt-3 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                                    重试
                                </button>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('加载消费列表失败:', error);
                    
                    // 清空表格
                    const tableBody = document.getElementById('consumptionTableBody');
                    tableBody.innerHTML = '';
                    const mobileList = document.getElementById('mobileConsumptionList');
                    mobileList.innerHTML = '';
                    
                    // 在表格中显示错误提示（桌面端）
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td colspan="9" class="px-4 py-10 text-center text-gray-500">
                            <i class="fa fa-exclamation-circle text-3xl mb-3"></i>
                            <p>加载失败</p>
                            <p class="text-sm text-gray-400 mt-1">${error.message || '网络错误，请重试'}</p>
                            <button onclick="loadConsumptionList()" class="mt-3 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                                重试
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                    
                    // 在移动端显示错误提示
                    mobileList.innerHTML = `
                        <div class="card p-10 text-center text-gray-500">
                            <i class="fa fa-exclamation-circle text-3xl mb-3"></i>
                            <p>加载失败</p>
                            <p class="text-sm text-gray-400 mt-1">${error.message || '网络错误，请重试'}</p>
                            <button onclick="loadConsumptionList()" class="mt-3 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                                重试
                            </button>
                        </div>
                    `;
                });
        }

        // 单条新增弹窗
        function openAddModal() {
            document.getElementById('addModal').classList.remove('hidden');
        }
        function closeAddModal() {
            document.getElementById('addModal').classList.add('hidden');
        }
        function toggleStats(checkbox) {
            const statsSection = document.getElementById('statsSection');
            if (checkbox.checked) {
                statsSection.classList.remove('opacity-50', 'pointer-events-none');
            } else {
                statsSection.classList.add('opacity-50', 'pointer-events-none');
                // 清空统计相关字段
                document.getElementById('subType').value = '';
                document.getElementById('unitCoefficient').value = '1';
            }
        }

        // 收货状态 Action Sheet 控制
        function showReceiveStatusActionSheet() {
            const actionSheet = document.getElementById('receiveStatusActionSheet');
            const currentValue = document.getElementById('receiveStatus').value;
            
            // 更新选中状态
            document.getElementById('check-已收货').classList.add('opacity-0');
            document.getElementById('check-待收货').classList.add('opacity-0');
            document.getElementById('check-' + currentValue).classList.remove('opacity-0');
            
            actionSheet.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeReceiveStatusActionSheet(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('receiveStatusActionSheet').classList.add('hidden');
            document.body.style.overflow = '';
        }

        function selectReceiveStatusFromActionSheet(value) {
            document.getElementById('receiveStatus').value = value;
            document.getElementById('receiveStatusText').textContent = value;
            closeReceiveStatusActionSheet();
        }
        function submitAdd() {
            const subType = document.getElementById('subType').value;
            const unitCoefficient = document.getElementById('unitCoefficient').value;
            
            // 验证：如果选择了统计类型，则换算系数必填
            if (subType && !unitCoefficient) {
                showToast('选择统计类型后，换算系数为必填项！', 'info');
                return;
            }
            
            const data = {
                content: document.getElementById('content').value,
                quantity: document.getElementById('quantity').value,
                totalPrice: document.getElementById('totalPrice').value,
                channel: document.getElementById('channel').value,
                mainType: document.getElementById('mainType').value,
                subType: subType,
                unitCoefficient: unitCoefficient,
                receiveStatus: document.getElementById('receiveStatus').value,
                purchaseTime: document.getElementById('purchaseTime').value
            };
            fetch('/api/consumption', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                    closeAddModal();
                    loadConsumptionList();
                } else {
                    showToast(data.message, 'error');
                }
            });
        }

        // 批量新增弹窗
        function openBatchModal() {
            document.getElementById('batchModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            // 阻止背景页面滚动
            document.body.addEventListener('touchmove', preventBodyScroll, { passive: false });
        }
        function closeBatchModal() {
            document.getElementById('batchModal').classList.add('hidden');
            document.body.style.overflow = '';
            // 恢复背景页面滚动
            document.body.removeEventListener('touchmove', preventBodyScroll);
        }
        function preventBodyScroll(e) {
            e.preventDefault();
        }
        function addMoreBatchItem() {
            const container = document.getElementById('batchFormContainer');
            const itemCount = container.querySelectorAll('.batch-item').length + 1;
            const newItem = document.createElement('div');
            newItem.className = 'batch-item bg-gray-50 rounded-xl p-3';
            newItem.innerHTML = `
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-gray-400 text-sm w-6">${itemCount}</span>
                    <input type="text" class="batch-content flex-1 bg-white rounded-lg px-3 py-2 text-base outline-none" placeholder="消费内容">
                    <button onclick="removeBatchItem(this)" class="text-gray-300 hover:text-red-400 w-8">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <div class="flex gap-2 ml-6">
                    <div class="flex items-center bg-white rounded-lg px-2 py-2 flex-1">
                        <span class="text-gray-400 text-sm mr-1">¥</span>
                        <input type="number" class="batch-totalPrice w-full bg-transparent outline-none text-base" placeholder="金额" step="0.01">
                    </div>
                    <input type="number" class="batch-quantity w-16 bg-white rounded-lg px-2 py-2 text-center text-base outline-none" value="1" step="0.1" placeholder="数量">
                    <select class="batch-channel w-20 bg-white rounded-lg px-2 py-2 text-sm outline-none">
                        {% for ch in channels %}
                        <option value="{{ ch.name }}">{{ ch.name }}</option>
                        {% endfor %}
                    </select>
                    <select class="batch-mainType w-20 bg-white rounded-lg px-2 py-2 text-sm outline-none">
                        {% for mt in main_types %}
                        <option value="{{ mt.name }}">{{ mt.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            `;
            container.appendChild(newItem);
            // 应用统一设置
            applyBatchDefaults();
            // 滚动到新添加的项
            newItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function removeBatchItem(btn) {
            const container = document.getElementById('batchFormContainer');
            const items = container.querySelectorAll('.batch-item');
            if (items.length > 1) {
                btn.closest('.batch-item').remove();
                // 重新编号
                const remainingItems = container.querySelectorAll('.batch-item');
                remainingItems.forEach((item, index) => {
                    const numberEl = item.querySelector('.text-gray-400.text-sm');
                    if (numberEl) {
                        numberEl.textContent = `${index + 1}`;
                    }
                });
            } else {
                showToast('至少保留一项', 'info');
            }
        }

        function applyBatchDefaults() {
            const defaultChannel = document.getElementById('batchDefaultChannel').value;
            const defaultType = document.getElementById('batchDefaultType').value;
            
            const items = document.querySelectorAll('#batchFormContainer .batch-item');
            items.forEach(item => {
                const channelSelect = item.querySelector('.batch-channel');
                const typeSelect = item.querySelector('.batch-mainType');
                
                if (defaultChannel) {
                    channelSelect.value = defaultChannel;
                }
                if (defaultType) {
                    typeSelect.value = defaultType;
                }
            });
        }
        function submitBatch() {
            const items = document.querySelectorAll('#batchFormContainer > div');
            const list = [];
            let isValid = true;
            
            items.forEach(item => {
                const subType = item.querySelector('.batch-subType').value;
                const unitCoefficient = item.querySelector('.batch-unitCoefficient').value;
                
                // 验证：如果选择了统计类型，则换算系数必填
                if (subType && !unitCoefficient) {
                    showToast('选择统计类型后，换算系数为必填项！', 'info');
                    isValid = false;
                    return;
                }
                
                list.push({
                    content: item.querySelector('.batch-content').value,
                    quantity: item.querySelector('.batch-quantity').value,
                    totalPrice: item.querySelector('.batch-totalPrice').value,
                    channel: item.querySelector('.batch-channel').value,
                    mainType: item.querySelector('.batch-mainType').value,
                    subType: subType,
                    unitCoefficient: unitCoefficient
                });
            });
            
            if (!isValid) {
                return;
            }
            
            fetch('/api/consumption/batch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ list })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                    closeBatchModal();
                    loadConsumptionList();
                } else {
                    showToast(data.message, 'error');
                }
            });
        }

        // 修改消费项
        function editItem(item) {
            // 修改弹窗标题
            document.querySelector('#addModal h3').textContent = '修改消费项';
            
            // 填充到新增弹窗（复用弹窗）
            document.getElementById('content').value = item.content || '';
            document.getElementById('quantity').value = item.quantity || 1;
            document.getElementById('totalPrice').value = item.total_price || 0;
            document.getElementById('channel').value = item.channel || '';
            document.getElementById('mainType').value = item.main_type || '';
            document.getElementById('subType').value = item.sub_type || '';
            document.getElementById('unitCoefficient').value = item.unit_coefficient || 1;
            document.getElementById('receiveStatus').value = item.receive_status || '已收货';
            document.getElementById('purchaseTime').value = item.create_time ? item.create_time : '';
            
            // 替换提交按钮为更新逻辑
            const submitBtn = document.querySelector('#addModal .btn-action');
            submitBtn.onclick = function() {
                const subType = document.getElementById('subType').value;
                const unitCoefficient = document.getElementById('unitCoefficient').value;
                
                // 验证：如果选择了统计类型，则换算系数必填
                if (subType && !unitCoefficient) {
                    showToast('选择统计类型后，换算系数为必填项！', 'info');
                    return;
                }
                
                const data = {
                    content: document.getElementById('content').value,
                    quantity: document.getElementById('quantity').value,
                    totalPrice: document.getElementById('totalPrice').value,
                    channel: document.getElementById('channel').value,
                    mainType: document.getElementById('mainType').value,
                    subType: subType,
                    unitCoefficient: unitCoefficient,
                    receiveStatus: document.getElementById('receiveStatus').value,
                    purchaseTime: document.getElementById('purchaseTime').value
                };
                fetch(`/api/consumption/${item.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showToast(data.message, 'success');
                        closeAddModal();
                        loadConsumptionList();
                        // 恢复提交按钮原逻辑
                        submitBtn.onclick = submitAdd;
                        // 恢复弹窗标题
                        document.querySelector('#addModal h3').textContent = '新增消费项';
                    } else {
                        showToast(data.message, 'error');
                    }
                });
            };
            openAddModal();
        }

        // 使用消费项
        let currentUseItem = null;
        function useItem(item) {
            currentUseItem = item;
            document.getElementById('useItemInfo').innerHTML = `
                <p><strong>消费内容：</strong>${item.content}</p>
                <p><strong>数量：</strong>${item.quantity}</p>
                <p><strong>总价：</strong>¥${item.total_price.toFixed(2)}</p>
                <p><strong>统计类型：</strong>${item.sub_type || '未设置'}</p>
            `;
            
            // 清空表单容器，只保留一个初始表单
            const container = document.getElementById('useFormContainer');
            container.innerHTML = `
                <div class="flex flex-wrap gap-4 items-center">
                    <div class="flex-1 min-w-[200px] date-input-wrapper">
                        <label class="block text-sm font-medium text-secondary mb-1">使用开始时间</label>
                        <input type="text" class="use-start-time input w-full" placeholder="选择开始时间">
                    </div>
                    <div class="flex-1 min-w-[200px] date-input-wrapper">
                        <label class="block text-sm font-medium text-secondary mb-1">使用结束时间</label>
                        <input type="text" class="use-end-time input w-full" placeholder="选择结束时间">
                    </div>
                </div>
            `;

            // 初始化日期选择器
            setTimeout(() => {
                const startTimeInputs = document.querySelectorAll('.use-start-time');
                const endTimeInputs = document.querySelectorAll('.use-end-time');

                startTimeInputs.forEach(input => {
                    flatpickr(input, {
                        locale: 'zh',
                        dateFormat: 'Y-m-d',
                        disableMobile: false,
                        position: isMobile ? 'auto' : 'auto',
                        appendTo: document.body,
                        clickOpens: true,
                        allowInput: false
                    });
                });

                endTimeInputs.forEach(input => {
                    flatpickr(input, {
                        locale: 'zh',
                        dateFormat: 'Y-m-d',
                        disableMobile: false,
                        position: isMobile ? 'auto' : 'auto',
                        appendTo: document.body,
                        clickOpens: true,
                        allowInput: false
                    });
                });
            }, 100);
            
            document.getElementById('useModal').classList.remove('hidden');
        }
        function closeUseModal() {
            document.getElementById('useModal').classList.add('hidden');
            currentUseItem = null;
        }
        function addMoreUseItem() {
            if (!currentUseItem) return;
            
            const container = document.getElementById('useFormContainer');
            const useItems = container.querySelectorAll('div.flex.flex-wrap.gap-4.items-center');
            
            // 检查是否超过数量限制
            if (useItems.length >= currentUseItem.quantity) {
                showToast(`使用记录数量不能超过消费项数量（${currentUseItem.quantity}）！`, 'info');
                return;
            }
            
            const newItem = document.createElement('div');
            newItem.className = 'flex flex-wrap gap-4 items-center';
            newItem.innerHTML = `
                <div class="flex-1 min-w-[200px] date-input-wrapper">
                    <label class="block text-sm font-medium text-secondary mb-1">使用开始时间</label>
                    <input type="text" class="use-start-time input w-full" placeholder="选择开始时间">
                </div>
                <div class="flex-1 min-w-[200px] date-input-wrapper">
                    <label class="block text-sm font-medium text-secondary mb-1">使用结束时间</label>
                    <input type="text" class="use-end-time input w-full" placeholder="选择结束时间">
                </div>
            `;
            container.appendChild(newItem);
            
            // 初始化新添加的日期选择器
            setTimeout(() => {
                const newStartTimeInput = newItem.querySelector('.use-start-time');
                const newEndTimeInput = newItem.querySelector('.use-end-time');

                flatpickr(newStartTimeInput, {
                    locale: 'zh',
                    dateFormat: 'Y-m-d',
                    disableMobile: false,
                    position: isMobile ? 'auto' : 'auto',
                    appendTo: document.body,
                    clickOpens: true,
                    allowInput: false
                });

                flatpickr(newEndTimeInput, {
                    locale: 'zh',
                    dateFormat: 'Y-m-d',
                    disableMobile: false,
                    position: isMobile ? 'auto' : 'auto',
                    appendTo: document.body,
                    clickOpens: true,
                    allowInput: false
                });
            }, 100);
        }
        function submitUseItem() {
            if (!currentUseItem) return;
            
            const useItems = document.querySelectorAll('#useFormContainer > div');
            const useRecords = [];
            
            useItems.forEach((item, index) => {
                const startTime = item.querySelector('.use-start-time').value;
                const endTime = item.querySelector('.use-end-time').value;
                
                if (startTime && endTime) {
                    useRecords.push({
                        startUseTime: startTime,
                        endUseTime: endTime
                    });
                }
            });
            
            if (useRecords.length === 0) {
                showToast('请至少填写一条使用记录！', 'info');
                return;
            }

            // 这里可以根据实际需求处理使用记录
            // 例如，更新消费项的使用状态，或者创建使用记录
            showToast(`成功提交 ${useRecords.length} 条使用记录！`, 'success');
            closeUseModal();
            loadConsumptionList();
        }

        // 通过ID编辑消费项
        function editItemById(id) {
            console.log('开始编辑消费项，ID:', id);
            fetch(`/api/consumption/${id}`)
                .then(res => {
                    console.log('API响应状态:', res.status);
                    if (!res.ok) {
                        throw new Error('网络响应错误: ' + res.status);
                    }
                    return res.json();
                })
                .then(data => {
                    console.log('获取消费项数据:', data);
                    if (data.success) {
                        editItem(data.data);
                    } else {
                        showToast('获取数据失败: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('获取消费项失败:', error);
                    showToast('网络错误，请重试！', 'error');
                });
        }

        // 通过ID使用消费项
        function useItemById(id) {
            console.log('开始使用消费项，ID:', id);
            fetch(`/api/consumption/${id}`)
                .then(res => {
                    console.log('API响应状态:', res.status);
                    if (!res.ok) {
                        throw new Error('网络响应错误: ' + res.status);
                    }
                    return res.json();
                })
                .then(data => {
                    console.log('获取消费项数据:', data);
                    if (data.success) {
                        useItem(data.data);
                    } else {
                        showToast('获取数据失败: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('获取消费项失败:', error);
                    showToast('网络错误，请重试！', 'error');
                });
        }

        // 删除消费项
        function deleteItem(id) {
            // 使用更明确的确认对话框
            const result = window.confirm(`确定删除ID为${id}的消费项吗？`);
            if (result) {
                fetch(`/api/consumption/${id}`, { method: 'DELETE' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showToast(data.message, 'success');
                        loadConsumptionList();
                    } else {
                        showToast(data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('删除失败：', error);
                    showToast('删除失败，请重试！', 'error');
                });
            }
        }

        // 格式化日期显示
        function formatDateDisplay(dateStr) {
            if (!dateStr) return '';
            try {
                // 尝试解析带时间的格式
                const dt = new Date(dateStr);
                const year = dt.getFullYear();
                const month = String(dt.getMonth() + 1).padStart(2, '0');
                const day = String(dt.getDate()).padStart(2, '0');
                const hours = String(dt.getHours()).padStart(2, '0');
                const minutes = String(dt.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day} ${hours}:${minutes}`;
            } catch (error) {
                return dateStr;
            }
        }

        // 页面加载时加载列表
        window.onload = loadConsumptionList;
    </script>

    <!-- 收货状态 Action Sheet -->
    <div id="receiveStatusActionSheet" class="fixed inset-0 bg-black/50 z-[60] hidden" onclick="closeReceiveStatusActionSheet(event)">
        <div class="absolute inset-x-0 bottom-0 bg-gray-100 rounded-t-3xl overflow-hidden" onclick="event.stopPropagation()">
            <!-- 头部拖动条 -->
            <div class="bg-white pt-3 pb-4 px-4">
                <div class="w-10 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
                <h3 class="text-lg font-semibold text-center text-gray-800">选择收货状态</h3>
            </div>
            <!-- 选项列表 -->
            <div class="bg-white mt-2">
                <div onclick="selectReceiveStatusFromActionSheet('已收货')" class="px-4 py-4 flex items-center justify-between border-b border-gray-100 active:bg-gray-50">
                    <span class="text-lg text-gray-800">已收货</span>
                    <i id="check-已收货" class="fa fa-check text-primary text-xl opacity-0"></i>
                </div>
                <div onclick="selectReceiveStatusFromActionSheet('待收货')" class="px-4 py-4 flex items-center justify-between active:bg-gray-50">
                    <span class="text-lg text-gray-800">待收货</span>
                    <i id="check-待收货" class="fa fa-check text-primary text-xl opacity-0"></i>
                </div>
            </div>
            <!-- 取消按钮 -->
            <div class="bg-white mt-2">
                <button onclick="closeReceiveStatusActionSheet()" class="w-full py-4 text-lg text-gray-800 font-medium active:bg-gray-50">
                    取消
                </button>
            </div>
            <!-- 底部安全区域 -->
            <div class="bg-white h-6"></div>
        </div>
    </div>
</body>
</html>