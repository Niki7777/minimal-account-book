<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»Ÿè®¡ - æç®€è®°è´¦æœ¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Flatpickr (ç°ä»£åŒ–æ—¥æœŸé€‰æ‹©å™¨) -->
    <link href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n/zh.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        info: '#06b6d4',
                        light: '#f9fafb',
                        dark: '#1e293b',
                        'primary-light': '#dbeafe',
                        'secondary-light': '#f1f5f9',
                        'border-color': '#e2e8f0'
                    },
                    fontFamily: {
                        sans: ['Inter', 'Microsoft YaHei', 'sans-serif']
                    },
                    boxShadow: {
                        'card': '0 2px 8px 0 rgba(0, 0, 0, 0.08)',
                        'card-hover': '0 4px 16px 0 rgba(0, 0, 0, 0.12)',
                        'modal': '0 8px 32px 0 rgba(0, 0, 0, 0.16)'
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card {
                @apply bg-white rounded-xl shadow-card transition-all duration-300;
            }
            .card:hover {
                @apply shadow-card-hover transform -translate-y-1;
            }
            .btn {
                @apply px-4 py-2 rounded-lg font-medium transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2;
            }
            .btn-primary {
                @apply bg-primary text-white hover:bg-primary/90 focus:ring-primary;
            }
            .btn-secondary {
                @apply bg-secondary text-white hover:bg-secondary/90 focus:ring-secondary;
            }
            .btn-success {
                @apply bg-success text-white hover:bg-success/90 focus:ring-success;
            }
            .btn-danger {
                @apply bg-danger text-white hover:bg-danger/90 focus:ring-danger;
            }
            .btn-outline {
                @apply border border-border-color text-secondary hover:bg-secondary-light focus:ring-primary;
            }
            .input {
                @apply w-full px-4 py-2 border border-border-color rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent;
            }
            .select {
                @apply w-full px-4 py-2 border border-border-color rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent;
            }
            .nav-item {
                @apply flex flex-col items-center justify-center gap-1 px-4 py-3 transition-all duration-200 relative;
            }
            .nav-item.active {
                @apply text-primary;
            }
            .nav-item.active::after {
                @apply content-[''] absolute bottom-0 left-1/2 transform -translate-x-1/2 w-1/2 h-0.5 bg-primary rounded-full;
            }
            .nav-item:hover {
                @apply text-primary;
            }
            .nav-icon {
                @apply text-xl;
            }
            .nav-label {
                @apply text-xs font-medium;
            }
            .table-hover {
                @apply hover:bg-gray-50 transition-colors;
            }
        }
    </style>
    <style>
        /* å…¨å±€æ ·å¼ */
        body {
            font-family: 'Inter', 'Microsoft YaHei', sans-serif;
        }
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-light font-sans">
    <!-- ä¸»å†…å®¹åŒº -->
    <main class="flex-grow container mx-auto px-4 py-6 pb-20">
        <div class="space-y-6">
            <div class="flex justify-between items-center">
                <h1 class="text-xl sm:text-2xl font-bold text-secondary">ç»Ÿè®¡</h1>
            </div>

        <!-- æŸ¥è¯¢è¡¨å• -->
        <div class="card mb-6 p-6">
            <div class="flex flex-col md:flex-row items-start md:items-center gap-4 mb-4">
                <label for="subType" class="text-sm font-medium text-gray-700 w-full md:w-24">ç»Ÿè®¡ç±»å‹ï¼š</label>
                <select id="subType" class="select flex-1">
                    <option value="">è¯·é€‰æ‹©ç»Ÿè®¡ç±»å‹</option>
                    {% for type in sub_types %}
                        <option value="{{ type.name }}">{{ type.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex flex-col md:flex-row items-start md:items-center gap-4 mb-6">
                <label class="text-sm font-medium text-gray-700 w-full md:w-24">æ—¶é—´èŒƒå›´ï¼š</label>
                <div class="flex flex-col md:flex-row gap-4 flex-1">
                    <div class="flex-1">
                        <input type="text" id="startDate" placeholder="å¼€å§‹æ—¥æœŸ" class="input">
                    </div>
                    <div class="flex-1">
                        <input type="text" id="endDate" placeholder="ç»“æŸæ—¥æœŸ" class="input">
                    </div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="queryPrice()">æŸ¥è¯¢</button>
        </div>

        <!-- ä»·æ ¼ç»Ÿè®¡ï¼ˆæŸ¥è¯¢åæ˜¾ç¤ºï¼‰ -->
        <div id="priceStat" class="mb-6" style="display: none;"></div>

        <!-- ä»·æ ¼åˆ—è¡¨è¡¨æ ¼ - æ¡Œé¢ç«¯ -->
        <div class="card overflow-x-auto hidden md:block">
            <table class="w-full border-collapse" id="priceTable">
                <thead>
                    <tr class="bg-secondary-light">
                        <th class="px-4 py-3 text-left text-sm font-medium text-secondary border-b border-border-color whitespace-nowrap">æ¶ˆè´¹å†…å®¹</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-secondary border-b border-border-color whitespace-nowrap">ç»Ÿè®¡ç±»å‹</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-secondary border-b border-border-color whitespace-nowrap">æ€»ä»·</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-secondary border-b border-border-color whitespace-nowrap">æœ€å°å•ä½å•ä»·</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-secondary border-b border-border-color whitespace-nowrap">è´­ä¹°æ—¥æœŸ</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-secondary border-b border-border-color whitespace-nowrap">è´­ä¹°æ¸ é“</th>
                    </tr>
                </thead>
                <tbody id="priceTableBody">
                    <tr>
                        <td colspan="6" class="py-16 text-center text-gray-500 text-lg">
                            è¯·é€‰æ‹©ç»Ÿè®¡ç±»å‹å¹¶ç‚¹å‡»æŸ¥è¯¢ ğŸ“Š
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- ä»·æ ¼åˆ—è¡¨å¡ç‰‡ - ç§»åŠ¨ç«¯ -->
        <div class="space-y-4 md:hidden" id="mobilePriceList">
            <div class="card p-10 text-center text-gray-500">
                <i class="fa fa-search text-3xl mb-3"></i>
                <p>è¯·é€‰æ‹©ç»Ÿè®¡ç±»å‹å¹¶ç‚¹å‡»æŸ¥è¯¢</p>
                <p class="text-sm text-gray-400 mt-1">ğŸ“Š</p>
            </div>
        </div>
        </div>
    </main>

    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <footer class="fixed bottom-0 left-0 right-0 bg-white shadow-md z-40">
        <div class="flex justify-around items-center h-16">
            <a href="/" class="nav-item">
                <i class="fa fa-home nav-icon"></i>
                <span class="nav-label">é¦–é¡µ</span>
            </a>
            <a href="/list" class="nav-item">
                <i class="fa fa-plus-circle nav-icon"></i>
                <span class="nav-label">è®°è´¦</span>
            </a>
            <a href="/pending" class="nav-item">
                <i class="fa fa-truck nav-icon"></i>
                <span class="nav-label">å¾…æ”¶è´§</span>
                {% if pending_count > 0 %}
                <span class="absolute -top-1 -right-1 bg-danger text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">
                    {{ pending_count }}
                </span>
                {% endif %}
            </a>
            <a href="/price" class="nav-item active">
                <i class="fa fa-bar-chart nav-icon"></i>
                <span class="nav-label">ç»Ÿè®¡</span>
            </a>
            <a href="/manage" class="nav-item">
                <i class="fa fa-cog nav-icon"></i>
                <span class="nav-label">è®¾ç½®</span>
            </a>
        </div>
    </footer>

    <!-- è„šæœ¬ï¼šä»·æ ¼æŸ¥è¯¢é€»è¾‘ -->
    <script>
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–æ—¥æœŸé€‰æ‹©å™¨
            if (typeof flatpickr !== 'undefined') {
                try {
                    flatpickr('#startDate', {
                        locale: 'zh',
                        dateFormat: 'Y-m-d',
                        maxDate: 'today'
                    });
                    
                    flatpickr('#endDate', {
                        locale: 'zh',
                        dateFormat: 'Y-m-d',
                        maxDate: 'today'
                    });
                } catch (error) {
                    console.error('åˆå§‹åŒ–æ—¥æœŸé€‰æ‹©å™¨å¤±è´¥:', error);
                }
            }
            
            // è®¾ç½®é»˜è®¤æ—¶é—´èŒƒå›´ä¸ºè¿‘20å¤©
            setDefaultDateRange();
        });
        
        // è®¾ç½®é»˜è®¤æ—¶é—´èŒƒå›´ä¸ºè¿‘20å¤©
        function setDefaultDateRange() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 19); // è¿‘20å¤©
            
            // æ ¼å¼åŒ–æ—¥æœŸä¸º YYYY-MM-DD
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            document.getElementById('startDate').value = formatDate(startDate);
            document.getElementById('endDate').value = formatDate(endDate);
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
        function formatDateDisplay(dateStr) {
            if (!dateStr) return '';
            try {
                // å°è¯•è§£æå¸¦æ—¶é—´çš„æ ¼å¼
                const dt = new Date(dateStr);
                const year = dt.getFullYear();
                const month = String(dt.getMonth() + 1).padStart(2, '0');
                const day = String(dt.getDate()).padStart(2, '0');
                const hours = String(dt.getHours()).padStart(2, '0');
                const minutes = String(dt.getMinutes()).padStart(2, '0');
                const seconds = String(dt.getSeconds()).padStart(2, '0');
                return `${year}å¹´${month}æœˆ${day}æ—¥ ${hours}:${minutes}:${seconds}`;
            } catch (error) {
                return dateStr;
            }
        }

        // æŸ¥è¯¢ä»·æ ¼
        function queryPrice() {
            const subType = document.getElementById('subType').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!subType) {
                alert('è¯·é€‰æ‹©è¦æŸ¥è¯¢çš„ç»Ÿè®¡ç±»å‹ï¼');
                return;
            }

            // æ„å»ºAPIè¯·æ±‚URL
            let url = `/api/consumption/type/${encodeURIComponent(subType)}`;
            if (startDate && endDate) {
                url += `?startDate=${startDate}&endDate=${endDate}`;
            }

            // è°ƒç”¨ä»·æ ¼æŸ¥è¯¢æ¥å£
            fetch(url)
            .then(response => response.json())
            .then(data => {
                const tableBody = document.getElementById('priceTableBody');
                const mobileList = document.getElementById('mobilePriceList');
                const priceStat = document.getElementById('priceStat');
                
                // æ¸…ç©ºåŸæœ‰å†…å®¹
                tableBody.innerHTML = '';
                mobileList.innerHTML = '';
                
                if (data.success && data.data.length > 0) {
                    // æ¸²æŸ“ä»·æ ¼åˆ—è¡¨ï¼ˆæ¡Œé¢ç«¯ï¼‰
                    data.data.forEach(item => {
                        const tr = document.createElement('tr');
                        tr.className = 'table-hover';
                        tr.innerHTML = `
                            <td class="px-4 py-3 text-sm border-b whitespace-nowrap">${item.content}</td>
                            <td class="px-4 py-3 text-sm border-b whitespace-nowrap">${item.sub_type}</td>
                            <td class="px-4 py-3 text-sm font-medium text-secondary border-b whitespace-nowrap">Â¥${item.total_price}</td>
                            <td class="px-4 py-3 text-sm border-b whitespace-nowrap">Â¥${item.min_unit_price || '0.00'}</td>
                            <td class="px-4 py-3 text-sm border-b whitespace-nowrap">${formatDateDisplay(item.create_time)}</td>
                            <td class="px-4 py-3 text-sm border-b whitespace-nowrap">${item.channel}</td>
                        `;
                        tableBody.appendChild(tr);
                    });
                    
                    // æ¸²æŸ“ä»·æ ¼åˆ—è¡¨ï¼ˆç§»åŠ¨ç«¯ï¼‰
                    data.data.forEach(item => {
                        const card = document.createElement('div');
                        card.className = 'card p-4';
                        card.innerHTML = `
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h3 class="font-medium text-secondary mb-1">${item.content}</h3>
                                    <p class="text-sm text-gray-500">ç»Ÿè®¡ç±»å‹: ${item.sub_type}</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mb-3">
                                <div class="text-sm">
                                    <span class="text-gray-500">æ€»ä»·:</span> <span class="font-medium text-secondary">Â¥${item.total_price}</span>
                                </div>
                                <div class="text-sm">
                                    <span class="text-gray-500">æœ€å°å•ä½å•ä»·:</span> Â¥${item.min_unit_price || '0.00'}
                                </div>
                                <div class="text-sm">
                                    <span class="text-gray-500">è´­ä¹°æ—¥æœŸ:</span> ${formatDateDisplay(item.create_time).split(' ')[0]}
                                </div>
                                <div class="text-sm">
                                    <span class="text-gray-500">è´­ä¹°æ¸ é“:</span> ${item.channel}
                                </div>
                            </div>
                        `;
                        mobileList.appendChild(card);
                    });

                    // è®¡ç®—ä»·æ ¼ç»Ÿè®¡ï¼ˆå‡ä»·ã€æœ€ä½ä»·ã€æœ€é«˜ä»·ï¼‰
                    const prices = data.data.map(item => {
                        const price = parseFloat(item.min_unit_price);
                        return isNaN(price) ? 0 : price;
                    });
                    let avgPrice = '0.00';
                    let minPrice = '0.00';
                    let maxPrice = '0.00';
                    
                    if (prices.length > 0) {
                        const validPrices = prices.filter(price => price > 0);
                        if (validPrices.length > 0) {
                            avgPrice = (validPrices.reduce((a, b) => a + b, 0) / validPrices.length).toFixed(2);
                            minPrice = Math.min(...validPrices).toFixed(2);
                            maxPrice = Math.max(...validPrices).toFixed(2);
                        }
                    }

                    // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                    priceStat.style.display = 'block';
                    priceStat.innerHTML = `
                        <div class="card p-4">
                            <div class="flex items-center gap-2 mb-3">
                                <i class="fa fa-bar-chart text-primary text-lg"></i>
                                <h3 class="text-lg font-semibold text-secondary">ç»Ÿè®¡ï¼ˆ${subType}ï¼‰</h3>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="bg-secondary-light/50 p-3 rounded-lg">
                                    <div class="text-xs text-gray-500 mb-1">è®°å½•æ•°</div>
                                    <div class="text-lg font-medium text-secondary">${data.count} æ¡</div>
                                </div>
                                <div class="bg-secondary-light/50 p-3 rounded-lg">
                                    <div class="text-xs text-gray-500 mb-1">æœ€å°å•ä½å‡ä»·</div>
                                    <div class="text-lg font-medium text-secondary">Â¥${avgPrice}</div>
                                </div>
                                <div class="bg-secondary-light/50 p-3 rounded-lg">
                                    <div class="text-xs text-gray-500 mb-1">æœ€ä½å•ä»·</div>
                                    <div class="text-lg font-medium text-secondary">Â¥${minPrice}</div>
                                </div>
                                <div class="bg-secondary-light/50 p-3 rounded-lg">
                                    <div class="text-xs text-gray-500 mb-1">æœ€é«˜å•ä»·</div>
                                    <div class="text-lg font-medium text-secondary">Â¥${maxPrice}</div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // ç©ºæ•°æ®æç¤ºï¼ˆæ¡Œé¢ç«¯ï¼‰
                    tableBody.innerHTML = `<tr><td colspan="6" class="py-16 text-center text-gray-500 text-lg">æš‚æ— ${subType}çš„ä»·æ ¼æ•°æ® ğŸ“­</td></tr>`;
                    
                    // ç©ºæ•°æ®æç¤ºï¼ˆç§»åŠ¨ç«¯ï¼‰
                    mobileList.innerHTML = `
                        <div class="card p-10 text-center text-gray-500">
                            <i class="fa fa-inbox text-3xl mb-3"></i>
                            <p>æš‚æ— ${subType}çš„ä»·æ ¼æ•°æ®</p>
                            <p class="text-sm text-gray-400 mt-1">ğŸ“­</p>
                        </div>
                    `;
                    
                    priceStat.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('ä»·æ ¼æŸ¥è¯¢å¤±è´¥ï¼š', error);
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•ï¼');
            });
        }
    </script>
</body>
</html>